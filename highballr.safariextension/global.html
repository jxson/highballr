<script type="text/javascript">
  // Event hadler for opening the contextual menu, adds our nice menu item
  function handleContextMenu(event){
    event.contextMenu.appendContextMenuItem('post-to-tumblr',
      '* Post to Tumblr');
  };

  function commandHandler(event){
    // this could get other commands make sure we are only working with the
    // right one
    if (event.command !== "post-to-tumblr") { return; }

    console.debug(event)

    safari
      .application
      .activeBrowserWindow
      .activeTab
      .page
      .dispatchMessage('injectHighballer', {'json': true});
  };

  // add a listener for the context menu coming up and add an item when it
  // does
  safari
    .application
    .addEventListener('contextmenu', handleContextMenu, false);

  //
  safari
    .application
    .addEventListener('command', commandHandler, false);
</script>